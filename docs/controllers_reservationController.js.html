<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/reservationController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/reservationController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file reservationController.js
 * @module controllers/reservationController
 * @brief Contrôleur pour la gestion des réservations : création, consultation et sièges réservés.
 * @description Permet de créer une réservation, de consulter les réservations de l'utilisateur connecté et de récupérer les sièges réservés pour un horaire donné. Toutes les fonctions sont asynchrones et renvoient des réponses JSON.
 *
 * @author UV PROJET CODE Team
 * @version 1.0
 * @date 2024-06-01
 */
// controllers/reservationController.js
const Reservation = require('../models/Reservation');
const Schedule = require('../models/Schedule');
const Ticket = require('../models/Ticket');
const QRCode = require('qrcode');

/**
 * @brief Crée une nouvelle réservation et génère un ticket avec QR code.
 * @param {Object} req Requête HTTP Express (body: schedule, nombre_places, seat).
 * @param {Object} res Réponse HTTP Express.
 * @returns {void}
 * @example
 * creerReservation(req, res);
 */
exports.creerReservation = async (req, res) => {
  try {
    const { schedule: scheduleId, nombre_places, seat } = req.body;
    const userId = req.user.userId;

    // On veut le bus pour le nom de compagnie
    const schedule = await Schedule.findById(scheduleId).populate('bus');
    if (!schedule) {
      return res.status(404).json({ message: "Horaire non trouvé" });
    }

    if (schedule.places_disponibles &lt; nombre_places) {
      return res.status(400).json({ message: "Pas assez de places disponibles" });
    }

    // Créer la réservation
    const reservation = new Reservation({ 
      user: userId, 
      schedule: scheduleId, 
      nombre_places 
    });
    await reservation.save();

    // Générer le QR code avec le nom de la compagnie
    const compagnie = schedule.bus?.compagnie || 'COMPAGNIE';
    const qrText = `${compagnie}.cm`;
    const qr_code = await QRCode.toDataURL(qrText);

    // Créer le ticket avec le QR code
    const ticket = new Ticket({
      reservation_id: reservation._id,
      user_id: userId,
      schedule: scheduleId,
      seat: seat || 'Non assigné',
      qr_code
    });
    await ticket.save();

    schedule.places_disponibles -= nombre_places;
    await schedule.save();

    res.status(201).json({ message: "Réservation créée avec succès", reservation, ticket });
  } catch (error) {
    res.status(500).json({ message: "Erreur lors de la création de la réservation.", error: error.message });
  }
};

/**
 * @brief Récupère les réservations de l'utilisateur connecté.
 * @param {Object} req Requête HTTP Express.
 * @param {Object} res Réponse HTTP Express.
 * @returns {void}
 * @example
 * mesReservations(req, res);
 */
exports.mesReservations = async (req, res) => {
  try {
    const reservations = await Reservation.find({ user: req.user.userId })
      .populate({
        path: 'schedule',
        populate: [
          { path: 'bus' },
          { path: 'terminal_depart' },
          { path: 'terminal_arrivee' }
        ]
      })
      .sort({ createdAt: -1 });

    res.json(reservations);
  } catch (error) {
    console.error("Erreur dans mesReservations:", error);
    res.status(500).json({ message: "Erreur lors de la récupération de vos réservations.", error: error.message });
  }
};

/**
 * @brief Récupère la liste des sièges réservés pour un horaire donné.
 * @param {Object} req Requête HTTP Express (params: scheduleId).
 * @param {Object} res Réponse HTTP Express.
 * @returns {void}
 * @example
 * getReservedSeats(req, res);
 */
exports.getReservedSeats = async (req, res) => {
  try {
    const { scheduleId } = req.params;
    const tickets = await Ticket.find({ schedule: scheduleId });
    const reservedSeats = tickets
      .map(t => t.seat)
      .filter(seat => seat &amp;&amp; seat !== 'Non assigné');
    res.json(reservedSeats);
  } catch (error) {
    res.status(500).json({ message: "Erreur lors de la récupération des sièges réservés.", error: error.message });
  }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-controllers_adminController.html">controllers/adminController</a></li><li><a href="module-controllers_authController.html">controllers/authController</a></li><li><a href="module-controllers_busController.html">controllers/busController</a></li><li><a href="module-controllers_paymentController.html">controllers/paymentController</a></li><li><a href="module-controllers_reservationController.html">controllers/reservationController</a></li><li><a href="module-controllers_scheduleController.html">controllers/scheduleController</a></li><li><a href="module-controllers_terminalController.html">controllers/terminalController</a></li><li><a href="module-controllers_ticketController.html">controllers/ticketController</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-server.html">server</a></li></ul><h3>Global</h3><ul><li><a href="global.html#adminMiddleware">adminMiddleware</a></li><li><a href="global.html#authMiddleware">authMiddleware</a></li><li><a href="global.html#connectDB">connectDB</a></li><li><a href="global.html#createAdminUser">createAdminUser</a></li><li><a href="global.html#sendOtpMail">sendOtpMail</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Jun 27 2025 13:10:21 GMT+0100 (heure normale d’Afrique de l’Ouest)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
